name: Test Ad Begone Startup

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test ad-begone addon starts (${{ matrix.arch }})
    strategy:
      matrix:
        arch: ["amd64", "aarch64"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v6.0.2

      - name: Set up QEMU
        if: matrix.arch != 'amd64'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read build configuration
        id: config
        run: |
          build_from=$(yq '.build_from.${{ matrix.arch }}' ./ad-begone/build.yaml)
          case "${{ matrix.arch }}" in
            amd64)   platform="linux/amd64" ;;
            aarch64) platform="linux/arm64" ;;
          esac
          echo "build_from=$build_from" >> $GITHUB_OUTPUT
          echo "platform=$platform" >> $GITHUB_OUTPUT

      - name: Build addon image
        run: |
          docker buildx build \
            --platform ${{ steps.config.outputs.platform }} \
            --build-arg BUILD_FROM=${{ steps.config.outputs.build_from }} \
            --load \
            -t addon-test:latest \
            ./ad-begone

      - name: Prepare test environment
        run: |
          mkdir -p /tmp/addon-data /tmp/podcast-media
          cat > /tmp/addon-data/options.json << 'EOF'
          {
            "podcast_directory": "/media/podcasts",
            "openai_api_key": "sk-test-placeholder",
            "openai_model": "gpt-4o"
          }
          EOF

      - name: Start addon container
        run: |
          docker run -d \
            --name addon-test \
            --platform ${{ steps.config.outputs.platform }} \
            -v /tmp/addon-data:/data \
            -v /tmp/podcast-media:/media/podcasts \
            addon-test:latest

      - name: Wait for addon to stay running
        timeout-minutes: 2
        run: |
          echo "Waiting for addon to stabilize..."
          for i in $(seq 1 15); do
            if [ "$(docker inspect -f '{{.State.Running}}' addon-test 2>/dev/null)" != "true" ]; then
              echo "::error::Container exited unexpectedly"
              docker logs addon-test
              exit 1
            fi

            echo "Attempt ${i}/15 - container is running, waiting 2s..."
            sleep 2
          done

          echo "Addon stayed running for 30 seconds"

      - name: Show addon logs
        if: always()
        run: docker logs addon-test 2>&1

      - name: Cleanup
        if: always()
        run: docker stop addon-test > /dev/null 2>&1 || true
