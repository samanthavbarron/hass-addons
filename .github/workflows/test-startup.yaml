name: Test Addon Startup

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test ${{ matrix.addon }} addon starts (${{ matrix.arch }})
    strategy:
      matrix:
        addon: ["audiobookshelf"]
        arch: ["amd64", "aarch64"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v6.0.2

      - name: Set up QEMU
        if: matrix.arch != 'amd64'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read build configuration
        id: config
        run: |
          build_from=$(yq '.build_from.${{ matrix.arch }}' ./${{ matrix.addon }}/build.yaml)
          port=$(yq '.ingress_port' ./${{ matrix.addon }}/config.yaml)
          # Map HA arch names to Docker platform strings
          case "${{ matrix.arch }}" in
            amd64)   platform="linux/amd64" ;;
            aarch64) platform="linux/arm64" ;;
          esac
          echo "build_from=$build_from" >> $GITHUB_OUTPUT
          echo "port=$port" >> $GITHUB_OUTPUT
          echo "platform=$platform" >> $GITHUB_OUTPUT

      - name: Build addon image
        run: |
          docker buildx build \
            --platform ${{ steps.config.outputs.platform }} \
            --build-arg BUILD_FROM=${{ steps.config.outputs.build_from }} \
            --load \
            -t addon-test:latest \
            ./${{ matrix.addon }}

      - name: Start addon container
        run: |
          docker run -d \
            --name addon-test \
            --platform ${{ steps.config.outputs.platform }} \
            -p ${{ steps.config.outputs.port }}:${{ steps.config.outputs.port }} \
            addon-test:latest

      - name: Wait for addon to become ready
        timeout-minutes: 2
        run: |
          port=${{ steps.config.outputs.port }}
          echo "Waiting for addon to respond on port ${port}..."
          for i in $(seq 1 30); do
            if curl -sf --max-time 5 "http://localhost:${port}" > /dev/null 2>&1; then
              echo "Addon is responding on port ${port}"
              exit 0
            fi

            if [ "$(docker inspect -f '{{.State.Running}}' addon-test 2>/dev/null)" != "true" ]; then
              echo "::error::Container exited unexpectedly"
              docker logs addon-test
              exit 1
            fi

            echo "Attempt ${i}/30 - waiting 2s..."
            sleep 2
          done

          echo "::error::Addon did not respond within 60 seconds"
          docker logs addon-test
          exit 1

      - name: Show addon logs
        if: always()
        run: docker logs addon-test 2>&1

      - name: Cleanup
        if: always()
        run: docker stop addon-test > /dev/null 2>&1 || true
